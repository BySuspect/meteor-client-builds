name: Build and Release

on:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout v0.5.4 code
              uses: actions/checkout@v3
              with:
                  ref: v0.5.4

            - name: Set up JDK 17
              uses: actions/setup-java@v3
              with:
                  distribution: "temurin"
                  java-version: "17"

            - name: Set up Gradle
              uses: gradle/gradle-build-action@v2

            - name: Build the mod
              run: ./gradlew build

            - name: List JAR files
              run: |
                  echo "Listing jar files in build/libs:"
                  ls build/libs/*.jar

            - name: Get Release Upload URL
              id: get_release
              run: |
                  response=$(curl -s \
                    -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    https://api.github.com/repos/${{ github.repository }}/releases/tags/v0.5.4)

                  upload_url=$(echo "$response" | jq -r .upload_url | sed -e "s/{?name,label}//")

                  if [ -z "$upload_url" ]; then
                    echo "Error: Failed to retrieve upload_url."
                    exit 1
                  fi

                  echo "upload_url=$upload_url" >> $GITHUB_OUTPUT

            - name: Upload JAR - All JAR
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.get_release.outputs.upload_url }}
                  asset_path: build/libs/meteor-client-0.5.4-all.jar
                  asset_name: meteor-client-0.5.4-all.jar
                  asset_content_type: application/java-archive

            - name: Upload JAR - Sources
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.get_release.outputs.upload_url }}
                  asset_path: build/libs/meteor-client-0.5.4-sources.jar
                  asset_name: meteor-client-0.5.4-sources.jar
                  asset_content_type: application/java-archive

            - name: Upload JAR - Main
              uses: actions/upload-release-asset@v1
              with:
                  upload_url: ${{ steps.get_release.outputs.upload_url }}
                  asset_path: build/libs/meteor-client-0.5.4.jar
                  asset_name: meteor-client-0.5.4.jar
                  asset_content_type: application/java-archive
